<div class="add-new-recipe-form">
    <mat-form-field appearance="outline">
        <mat-label>Recipe name</mat-label>
        <input matInput [formControl]="newRecipeForm.controls.name" />
        @if(newRecipeForm.get('name')?.hasError('required')) {
            <mat-error>Recipe Name is required.</mat-error>
        }
    </mat-form-field>
    <mat-form-field appearance="outline">
        <mat-label>Ingredients</mat-label>
        <mat-chip-grid #chipGrid>
            @for (ingredient of ingredientsSelected(); track $index) {
                <mat-chip-row (removed)="removeIngredient(ingredient)">
                    {{ingredient.label}}
                    <button matChipRemove>
                        <mat-icon>cancel</mat-icon>
                    </button>
                </mat-chip-row>
            }
        </mat-chip-grid>
        <input 
            matInput
            #ingredientInput
            [formControl]="newRecipeForm.controls.ingredient" 
            [matAutocomplete]="ingredientAutoComplete"
            [matChipInputFor]="chipGrid"
            />
        <mat-autocomplete 
            autoActiveFirstOption
            #ingredientAutoComplete="matAutocomplete" 
            (optionSelected)="selectIngredient($event); ingredientInput.value = ''">
            @for (option of (filteredIngredientsAndLabels | async); track option) {
                <mat-option [value]="option.label" [id]="option.id">{{option.label}}</mat-option>
            }
        </mat-autocomplete>
    </mat-form-field>
    @if(ingredientsSelected().length > 0) {
            @for(ingredient of ingredientsSelected(); track $index) {
                <mat-form-field class="ingredient-input">
                    <mat-label>{{ingredient.label}} Quantity</mat-label>
                    <input 
                        matInput
                        [formControl]="newRecipeForm.controls.ingredientQuantity.controls.at($index)!"/>
                    <button 
                        mat-icon-button 
                        matSuffix
                        (click)="removeIngredient(ingredient)">
                            <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>
            }
    }
    <mat-form-field appearance="outline">
        <mat-label>Servings</mat-label>
        <input matInput [formControl]="newRecipeForm.controls.servings"/>
        @if(newRecipeForm.get('servings')?.hasError('required')) {
            <mat-error>Serving size is required.</mat-error>
        }
    </mat-form-field>
    <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select [formControl]="newRecipeForm.controls.category">
        @if((recipeCategoriesAndLabels | async); as recipeCategoriesAndLabels) {
            @for(categoryAndLabel of recipeCategoriesAndLabels; track categoryAndLabel) {
                <mat-option [value]="categoryAndLabel.category">{{categoryAndLabel.label}}</mat-option>
            }
        }
        </mat-select>
        @if(newRecipeForm.get('category')?.hasError('required')) {
            <mat-error>Category is required.</mat-error>
        }
    </mat-form-field>
    <mat-form-field appearance="outline">
        <mat-label>Steps to follow</mat-label>
        <textarea matInput [formControl]="newRecipeForm.controls.steps"></textarea>
        @if(newRecipeForm.get('steps')?.hasError('required')) {
            <mat-error>Steps to follow is required.</mat-error>
        }
    </mat-form-field>
    <mat-form-field appearance="outline">
        <mat-label>Tags (comma seperated)</mat-label>
        <input matInput [formControl]="newRecipeForm.controls.tags"/>
    </mat-form-field>
    @if((isAddOrEditLoading|async) ?? true) {
        <mat-spinner [diameter]="50"></mat-spinner>
    } @else {
        <button mat-flat-button (click)="addNewRecipe()">
            {{isEditMode() ? 'Edit' : 'Add'}} Recipe
        </button>
    }
</div>